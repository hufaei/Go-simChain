# simchain-go V3-C 里程碑文档：TCP 健壮性 + 同步收敛 + 可观测性（对标 Bitcoin 节点行为）

本文件定义 V3-C 的**目标、范围、接口约束、验收标准与实施里程碑**，用于在当前 V3-B（同机多进程 TCP 网络 + seed 发现 + 最小身份绑定）基础上，使系统在“非理想网络条件下”依旧稳定同步、可观测、可诊断。

V3-C 的原则：**优先补齐“真实节点必备行为”**，对标 Bitcoin 的工程实践（headers-first 同步、inflight 控制、peer 冷却与观测），但保持模拟器的轻量与易理解。

---

## 0. 背景与前置（当前 V3-B 的关键能力）

当前系统已经具备：
- TCP 多进程网络（本机回环）、seed 发现、最小身份绑定
- headers-first 同步协议 + inv/get 传播模型
- 主链持久化（仅主链，不持久化分叉/交易池）
- 基础可观测输出（STATE_DUMP / SIMULATION_SUMMARY）

V3-C 的核心问题：
- 在 TCP 条件下，**同步过程仍偏“理想网络”**，需要更严格的超时/重试/peer 选择策略
- mempool/消息广播缺少现实约束（TTL、去重、限速）
- 缺少针对 peer 行为与同步耗时的**可观测指标**

---

## 1. V3-C 目标与非目标

### 1.1 目标（必须）
- **同步健壮性**：完善 Syncer 状态机（inflight 窗口、超时重试、peer 冷却/切换），在高延迟/丢包时仍能收敛。
- **mempool 现实约束**：引入 TTL、容量上限、去重控制，避免无限增长与广播风暴。
- **TCP 行为改良**：限速/限流、连接上限与异常 peer 处理策略的落地。
- **可观测性增强**：输出同步耗时、peer RTT、inflight 数量、超时/重试次数。

### 1.2 非目标（V3-C 暂不做）
- 真实交易验证（签名/UTXO/脚本）。
- 交易费用市场与打包策略（留到 V4）。
- 公网部署、跨机 NAT 穿透、加密传输。

---

## 2. 迭代方向（对齐 Bitcoin 行为的关键点）

### 2.1 同步状态机强化（Syncer）
- **headers-first** 仍为主，但要保证：
  - inflight 窗口大小可配置（例如 32）
  - 每个 inflight 记录 deadline
  - 超时触发 retry / peer 冷却
- **peer 选择/切换策略**：
  - 基于 cumWork + RTT + 失败率选择 best peer
  - 对连续超时的 peer 做冷却（backoff）
- **阻断重复下载**：维护 knownBlocks / inflightBlocks，防止重复拉取

### 2.2 mempool 现实约束
- **TTL 清理**：过期交易自动移除
- **容量上限**：例如 maxTxs 或 maxBytes
- **广播去重/限速**：避免对同一 tx 反复广播

### 2.3 TCP 连接与消息控制
- **连接上限**：max inbound/outbound/total
- **速率限制**：对单 peer 的消息频率做基本限制
- **异常 peer 处理**：无效消息/过大消息/连续超时 -> 断开

### 2.4 可观测性与诊断
- **增加关键指标输出**：
  - peer RTT（均值/近期）
  - inflight 数量
  - 超时与重试次数
  - 同步耗时（从落后到追平）
- **扩展 STATE_DUMP**：增量输出 peer 状态与同步状态

---

## 3. 里程碑（建议顺序）

1) **Syncer 状态机补齐**
   - inflight window + deadline + timeout retry
   - peer 冷却/切换逻辑
2) **mempool 约束落地**
   - TTL + size limit + 广播去重
3) **TCP 连接与限流**
   - max peers + per-peer rate limit
   - 异常 peer 断开逻辑
4) **可观测性增强**
   - RTT、超时、重试、同步耗时输出
   - STATE_DUMP 扩展
5) **回归与验收脚本（可选）**
   - 模拟丢包/延迟条件下同步恢复

---

## 4. 验收清单（必须通过）

在本机 3~5 个进程 + TCP 模式下满足：
- **高延迟/轻度丢包**场景下仍能完成 late join 同步
- **重复/失效消息**不会导致死锁或无限重试
- mempool **不会无限膨胀**（TTL/容量生效）
- 日志中可观测到 **peer RTT、超时、重试与 inflight 数量**
- 短暂分叉仍能收敛到累积工作量更大的主链

---

## 5. 自审（Self Review）

- [x] 里程碑目标清晰且可执行（避免“概念性”描述）
- [x] 明确区分“必须项”与“后续项”
- [x] 文档结构与现有 V3-B 文档风格一致
- [x] 验收清单可在本机 TCP 模式下验证
- [x] 不涉及 V4 范围（交易验证/费用市场）
